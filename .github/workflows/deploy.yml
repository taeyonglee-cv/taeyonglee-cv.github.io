name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 0 * * *'

permissions:
  contents: read
  pages: write
  id-token: write
  
jobs:
  update-citations:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: npm install
        
      - name: Run scholar crawler with retry logic
        run: |
          echo "Starting Google Scholar citation update..."
          
          # ê¸°ì¡´ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ë°±ì—…
          if [ -f data/publications.json ]; then
            echo "ğŸ“‹ Found existing publications.json, creating backup"
            cp data/publications.json data/publications.json.backup
          else
            echo "ğŸ“ No existing publications.json found"
            mkdir -p data
            echo "[]" > data/publications.json
          fi
          
          # 3ë²ˆ ì‹œë„
          SUCCESS=false
          for i in {1..3}; do
            echo ""
            echo "ğŸ”„ Attempt $i/3 to fetch Google Scholar data..."
            
            if node scripts/scholar-citation-crawler.js; then
              echo "âœ… Successfully fetched and updated citation data"
              SUCCESS=true
              break
            else
              echo "âŒ Attempt $i failed"
              
              # ë§ˆì§€ë§‰ ì‹œë„ê°€ ì•„ë‹ˆë©´ ëŒ€ê¸°
              if [ $i -lt 3 ]; then
                WAIT_TIME=$((30 + i * 15))  # 30ì´ˆ, 45ì´ˆ, ë§ˆì§€ë§‰ì—” ëŒ€ê¸° ì•ˆí•¨
                echo "â³ Waiting ${WAIT_TIME} seconds before next attempt..."
                sleep $WAIT_TIME
              fi
            fi
          done
          
          # ëª¨ë“  ì‹œë„ê°€ ì‹¤íŒ¨í•œ ê²½ìš°
          if [ "$SUCCESS" = false ]; then
            echo ""
            echo "âš ï¸  All attempts failed, but continuing with existing data"
            
            # ë°±ì—… íŒŒì¼ì´ ìˆìœ¼ë©´ ë³µì›
            if [ -f data/publications.json.backup ]; then
              echo "ğŸ“‹ Restoring from backup"
              cp data/publications.json.backup data/publications.json
            fi
            
            # íŒŒì¼ì´ ì•„ì˜ˆ ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´ ìƒì„±
            if [ ! -f data/publications.json ]; then
              echo "ğŸ“ Creating empty publications file"
              echo "[]" > data/publications.json
            fi
          fi
          
          # ë°±ì—… íŒŒì¼ ì •ë¦¬
          rm -f data/publications.json.backup
          
          # ìµœì¢… ê²°ê³¼ ì¶œë ¥
          echo ""
          echo "ğŸ“Š Final publications.json status:"
          if [ -f data/publications.json ]; then
            echo "âœ… File exists ($(wc -c < data/publications.json) bytes)"
            echo "ğŸ“– Content preview:"
            head -n 5 data/publications.json
          else
            echo "âŒ File does not exist"
            exit 1
          fi
        continue-on-error: false  # íŒŒì¼ì´ ì—†ìœ¼ë©´ ì‹¤íŒ¨
        
      - name: Verify publications data
        run: |
          echo "ğŸ” Verifying publications.json..."
          
          if [ ! -f data/publications.json ]; then
            echo "âŒ publications.json not found!"
            exit 1
          fi
          
          # JSON ìœ íš¨ì„± ê²€ì‚¬
          if ! python3 -m json.tool data/publications.json > /dev/null 2>&1; then
            echo "âŒ Invalid JSON format!"
            echo "ğŸ“„ File content:"
            cat data/publications.json
            exit 1
          fi
          
          # íŒŒì¼ í¬ê¸° í™•ì¸
          FILE_SIZE=$(wc -c < data/publications.json)
          echo "ğŸ“ File size: $FILE_SIZE bytes"
          
          if [ $FILE_SIZE -lt 2 ]; then
            echo "âŒ File too small (likely empty or corrupted)"
            exit 1
          fi
          
          echo "âœ… publications.json is valid"
          
      - name: Save updated publications.json
        uses: actions/upload-artifact@v4
        with:
          name: updated-data
          path: data/publications.json

  deploy:
    needs: update-citations
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Download updated publications.json
        uses: actions/download-artifact@v4
        with:
          name: updated-data
          path: tmp
          
      - name: Overwrite publications.json in repo
        run: |
          echo "ğŸ“ Setting up data directory..."
          mkdir -p data
          
          echo "ğŸ“‹ Copying updated publications.json..."
          cp tmp/publications.json data/publications.json
          
          echo "ğŸ” Verifying copied file..."
          if [ -f data/publications.json ]; then
            FILE_SIZE=$(wc -c < data/publications.json)
            echo "âœ… File copied successfully ($FILE_SIZE bytes)"
            
            # ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°
            echo "ğŸ“– Publications preview:"
            head -n 10 data/publications.json | sed 's/^/   /'
          else
            echo "âŒ Failed to copy publications.json"
            exit 1
          fi
          
      - name: Setup Pages
        uses: actions/configure-pages@v5
        
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .
          
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
      - name: Deployment summary
        run: |
          echo "ğŸš€ Deployment completed!"
          echo "ğŸ”— Site URL: ${{ steps.deployment.outputs.page_url }}"
          echo "ğŸ“… Deployed at: $(date)"
