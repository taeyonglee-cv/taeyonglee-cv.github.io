name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 0 * * *'

permissions:
  contents: read
  pages: write
  id-token: write
  
jobs:
  update-citations:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install Python dependencies
        run: |
          echo "📦 Installing Python packages..."
          pip install scholarly
          
      - name: Run Python scholar crawler
        run: |
          echo "Starting Google Scholar citation update with Python..."
          
          # 기존 데이터 백업
          if [ -f data/publications.json ]; then
            echo "📋 Found existing publications.json, creating backup"
            cp data/publications.json data/publications.json.backup
          else
            echo "📁 No existing publications.json found"
            mkdir -p data
            echo "[]" > data/publications.json
          fi
          
          # Python 크롤러 실행
          SUCCESS=false
          
          if [ -f scripts/gs_crawler.py ]; then
            echo "🐍 Running Python Google Scholar crawler..."
            
            # Python 스크립트 실행 (타임아웃 5분)
            if timeout 300 python scripts/gs_crawler.py; then
              echo "✅ Python crawler succeeded"
              SUCCESS=true
            else
              echo "❌ Python crawler failed or timed out"
            fi
          else
            echo "❌ gs_crawler.py not found!"
          fi
          
          # 실패한 경우 기존 데이터 복원
          if [ "$SUCCESS" = false ]; then
            echo ""
            echo "⚠️ Python crawler failed, but continuing with existing data"
            
            if [ -f data/publications.json.backup ]; then
              echo "📋 Restoring from backup"
              cp data/publications.json.backup data/publications.json
            fi
            
            if [ ! -f data/publications.json ] || [ ! -s data/publications.json ]; then
              echo "📝 Creating empty publications file"
              echo "[]" > data/publications.json
            fi
          fi
          
          # 백업 파일 정리
          rm -f data/publications.json.backup
          
          # 최종 상태 확인
          echo ""
          echo "📊 Final publications.json status:"
          if [ -f data/publications.json ]; then
            FILE_SIZE=$(wc -c < data/publications.json)
            echo "✅ File exists ($FILE_SIZE bytes)"
            if [ $FILE_SIZE -gt 2 ]; then
              echo "📖 Content preview:"
              head -n 5 data/publications.json
            fi
          else
            echo "❌ File does not exist"
            exit 1
          fi
        continue-on-error: false
        
      - name: Verify publications data
        run: |
          echo "🔍 Verifying publications.json..."
          
          if [ ! -f data/publications.json ]; then
            echo "❌ publications.json not found!"
            exit 1
          fi
          
          # JSON 유효성 검사
          if ! python3 -c "import json; json.load(open('data/publications.json'))" 2>/dev/null; then
            echo "❌ Invalid JSON format!"
            echo "📄 File content:"
            cat data/publications.json
            exit 1
          fi
          
          # 파일 크기 확인
          FILE_SIZE=$(wc -c < data/publications.json)
          echo "📏 File size: $FILE_SIZE bytes"
          
          if [ $FILE_SIZE -lt 2 ]; then
            echo "❌ File too small (likely empty or corrupted)"
            exit 1
          fi
          
          echo "✅ publications.json is valid"
          
      - name: Save updated publications.json
        uses: actions/upload-artifact@v4
        with:
          name: updated-data
          path: data/publications.json

  deploy:
    needs: update-citations
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Download updated publications.json
        uses: actions/download-artifact@v4
        with:
          name: updated-data
          path: tmp
          
      - name: Overwrite publications.json in repo
        run: |
          echo "📁 Setting up data directory..."
          mkdir -p data
          
          echo "📋 Copying updated publications.json..."
          cp tmp/publications.json data/publications.json
          
          echo "🔍 Verifying copied file..."
          if [ -f data/publications.json ]; then
            FILE_SIZE=$(wc -c < data/publications.json)
            echo "✅ File copied successfully ($FILE_SIZE bytes)"
            
            # 내용 미리보기
            echo "📖 Publications preview:"
            head -n 10 data/publications.json | sed 's/^/   /'
          else
            echo "❌ Failed to copy publications.json"
            exit 1
          fi
          
      - name: Setup Pages
        uses: actions/configure-pages@v5
        
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .
          
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
      - name: Deployment summary
        run: |
          echo "🚀 Deployment completed!"
          echo "🔗 Site URL: ${{ steps.deployment.outputs.page_url }}"
          echo "📅 Deployed at: $(date)"
